= form_for @league do |f|
  -if @league.errors.any?
    #error_explanation
      %h2= "#{pluralize(@league.errors.count, "error")} prohibited this league from being saved:"
      %ul
        - @league.errors.full_messages.each do |msg|
          %li= msg

  #tabs
    %ul
      %li
        = link_to "Details", "#league-details"
      %li
        = link_to "Regulations", "#league-regulations"
      %li
        = link_to "Settings", "#league-settings"
      %li
        = link_to "Classes", "#car-classes"
      %li
        = link_to "Allowed Cars", "#allowed-cars"
      %li
        = link_to "Point Settings", "#points"
      %li
        = link_to "Races", "#races"
    #league-details
      %table{:class => "race-table"}
        %tr
          %td{:class => "first"}
            = f.label :name
          %td
            = f.text_field :name, :class => "text-input"
        %tr
          %td
            = f.label :max_players
          %td
            = f.select :max_players, SiteConfig.max_players
        %tr
          %td
            = f.label "Status"
          %td
            %label{:style => "display: inline;"}
              Open
            = " - "
            = f.radio_button :open, true, :style => "display: inline;"
            %label{:style => "display: inline;"}
              Closed
            = " - "
            = f.radio_button :open, false, :style => "display: inline;"
            = note("When the league is complete close it.")
    #league-regulations
      - f.fields_for :race_regulations do |regs|
        = render :partial => 'races/race_regulations', :locals => {:f => regs}
    #league-settings
      - f.fields_for :event_settings do |es|
        = render :partial => 'races/event_settings', :locals => {:f => es}
    #car-classes
      %p
        If your league does not have car classes leave these blank
      %table{:class => "half"}
        %tr
          %th
            Name
          %th
            Max players
        - f.fields_for :car_classes do |cc|
          = render :partial => 'car_classes', :locals => {:f => cc}
    #allowed-cars
      %table{:class => "half"}
        %tr
          %th{:width => "20px", }
            Car
          %th
            Class
          %th
            Amount
          %th
            Restrictions
        - f.fields_for :league_cars do |cc|
          = render :partial => 'allowed_cars', :locals => {:f => cc}
    #races
      - if @league.new_record?
        Once you have created the league you can add races
      - else
        - if @league.races.blank?
          You have not races yet
          = link_to "Click here", new_league_race_path(@league)
        - unless @league.races.blank?
          = link_to "New race", "#", :class => "ui-icon ui-icon-plusthick", :title => "New race", :style => "float: left; margin-right: 5px;"
          = link_to 'New Race', new_league_race_path(@league)
          %table
            %tr
              %th Name
              %th Track
              %th Start time
              %th Entries
              %th

            - @league.races.each do |race|
              %tr
                %td= link_to race.name, race
                %td= link_to race.track.name, race
                %td= link_to "#{race.start_time.strftime("%d/%m/%y %I:%M%p")} #{ActiveSupport::TimeZone.zones_map[race.timezone]}", race
                %td= link_to "#{race.users.length}/#{race.max_players} (#{race.max_players - race.users.length} left)", "/races/#{race.id}#register"
                %td{:style => "min-width: 26px; text-align: center;"}
                  = link_to "Show", race, :class => "ui-icon ui-icon-search", :title => "View race details", :style => "float: left; margin-right: 5px;"
                  - if race.organiser.eql?(current_user)
                    = link_to 'Edit', edit_race_path(race), :class => "ui-icon ui-icon-wrench", :style => "float: left; margin-right: 5px;", :title => "Edit race details"
                    = link_to 'Destroy', race, :confirm => 'Are you sure?', :method => :delete, :class => "ui-icon ui-icon-trash", :style => "float: left; margin-right: 5px;", :title => "Delete race"
    #points
      %table{:class => "half"}
        %tr
          %th
            Position
          %th
            Points
        - pos = 1
        - f.fields_for :league_points do |lp|
          = render :partial => 'points_form', :locals => {:f => lp, :pos => pos}
          - pos += 1
  %p
    = f.submit 'Save', :class => "submit"
